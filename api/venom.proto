syntax = "proto3";
package venom;

option go_package = "github.com/mathiassmichno/venom/api;api";

import "google/protobuf/empty.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";

service VenomDaemon {
  rpc StartProcess(StartProcessRequest) returns (StartProcessResponse);
  rpc StopProcess(StopProcessRequest) returns (StopProcessResponse);
  rpc SendProcessInput(ProcessInput) returns (ProcessInputWritten);
  rpc ListProcesses(google.protobuf.Empty) returns (ListProcessesResponse);
  rpc StreamLogs(StreamLogsRequest) returns (stream LogEntry);
  rpc GetMetrics(google.protobuf.Empty) returns (MetricsResponse);
}

message ProcessDefinition {
  string name = 1;
  repeated string args = 2;
  string dir = 3;
  repeated string env = 4;
}

message ProcessStatus {
  oneof state {
    uint32 exit = 1;
    string error = 2;
  }
  google.protobuf.Duration runtime = 6;
}

message ProcessInfo {
  string id = 1;
  ProcessDefinition definition = 2;
  ProcessStatus status = 3;
}

message StartProcessRequest {
  ProcessDefinition definition = 1;
  bool with_stdin_pipe = 2;
  oneof wait_for {
    string regex = 3;
    bool exit = 4;
  }
  optional google.protobuf.Duration wait_timeout = 5;
}

message StartProcessResponse {
  string id = 1;
  bool success = 2;
  ProcessStatus status = 3;
}

message StopProcessRequest {
  string id = 1;
  bool wait = 2;
}

message StopProcessResponse {
  bool success = 1;
  ProcessStatus status = 2;
}

message ProcessInput {
  string id = 1;
  oneof input {
    string text = 2;
    bytes data = 3;
  }
  bool close = 4;
}

message ProcessInputWritten {
  bool success = 1;
  uint32 written = 2;
  oneof result {
    string error = 3;
    ProcessStatus status = 4;
  }
}

message StreamLogsRequest {
  string id = 1;
  bool from_start = 2;
}

message LogEntry {
  google.protobuf.Timestamp ts = 1;
  string line = 2;

  Stream stream = 3;
  enum Stream {
    STREAM_UNSPECIFIED = 0; // Default value.
    STDOUT = 1;             // Standard output.
    STDERR = 2;             // Standard error.
  }
}


message ListProcessesResponse {
  repeated ProcessInfo processes = 1;
}

message MetricsResponse {
  google.protobuf.Timestamp ts = 1;
  double cpu_percent = 2;
  double mem_percent = 3;
  uint64 mem_total = 4;
  uint64 mem_used = 5;
}

